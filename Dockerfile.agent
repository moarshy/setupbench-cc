# Dockerfile.agent
# Builds agent execution environment on top of any base image

ARG BASE_IMAGE=ubuntu:22.04
FROM ${BASE_IMAGE}

# Install Python 3, Node.js, and dependencies
# Use non-interactive frontend to avoid prompts
ENV DEBIAN_FRONTEND=noninteractive

RUN if command -v apt-get >/dev/null 2>&1; then \
        apt-get update && \
        apt-get install -y --no-install-recommends \
            python3 \
            python3-pip \
            python3-venv \
            ca-certificates \
            curl \
            gnupg && \
        # Upgrade pip to latest version (fixes ruby:2.7 compatibility)
        python3 -m pip install --upgrade pip && \
        # Install Node.js 20.x from NodeSource \
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
        apt-get install -y nodejs && \
        rm -rf /var/lib/apt/lists/*; \
    fi

# Install Claude Agent SDK and dependencies
# Note: --break-system-packages not available in Ubuntu 22.04's pip (22.0.2)
RUN pip3 install --no-cache-dir \
    claude-agent-sdk \
    python-dotenv \
    pydantic

# Install Claude Code CLI (required by claude-agent-sdk)
RUN npm install -g @anthropic-ai/claude-code

# Copy setupbench_runner package
COPY src/setupbench_runner /app/setupbench_runner

# Copy in-container agent script
COPY scripts/run_agent_in_container.py /app/run_agent_in_container.py

# Set working directory to /testbed (where task files will be)
WORKDIR /testbed

# Agent will be invoked with:
# python3 /app/run_agent_in_container.py <task_json> <api_key>
